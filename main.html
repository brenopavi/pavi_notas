<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Despesas</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #f4f7fb;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #0f172a;
      --muted: #64748b;
      --primary: #16a34a;
      --primary-dark: #15803d;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      color: var(--text);
    }

    .container {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      background: var(--card);
      padding: 22px 18px 24px;
      border-radius: 18px;
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.16);
      border: 1px solid var(--border);
    }

    h2 {
      text-align: center;
      margin: 0 0 6px;
      font-size: 21px;
      font-weight: 600;
    }

    .subtitle {
      margin: 0 0 18px;
      font-size: 15px;
      color: var(--muted);
      text-align: center;
    }

    label {
      display: block;
      margin: 12px 0 4px;
      font-weight: 500;
      font-size: 15px;
    }

    select,
    input[type="text"],
    input[type="number"],
    input[type="date"],
    textarea {
      width: 100%;
      padding: 13px 12px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      font-size: 17px;
      margin-bottom: 10px;
      background: #f8fafc;
      color: var(--text);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    select:focus,
    input:focus,
    textarea:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.25);
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 90px;
      font-size: 17px;
    }

    .icon-area {
      display: flex;
      gap: 12px;
      margin-top: 8px;
      justify-content: center;
    }

    .icon-btn {
      flex: 1;
      text-align: center;
      padding: 14px 0;
      border-radius: 12px;
      border: 1px dashed #cbd5e1;
      cursor: pointer;
      font-size: 15px;
      background: #f8fafc;
      transition: .2s;
      color: var(--muted);
    }

    .icon-btn span {
      display: block;
      font-size: 28px;
      margin-bottom: 4px;
    }

    .icon-btn:hover {
      background: #ecfdf3;
      border-color: #22c55e;
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.25);
      color: var(--primary-dark);
    }

    .btn-enviar {
      width: 100%;
      padding: 15px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 18px;
      box-shadow: 0 12px 26px rgba(22, 163, 74, 0.5);
      transition: .15s;
    }

    .btn-enviar:hover {
      opacity: .96;
      box-shadow: 0 14px 30px rgba(22, 163, 74, 0.55);
    }

    .btn-enviar:active {
      transform: translateY(1px);
      box-shadow: 0 8px 18px rgba(22, 163, 74, 0.42);
    }

    .status-box {
      margin-top: 14px;
      padding: 11px 12px;
      border-radius: 10px;
      font-size: 15px;
      display: none;
      text-align: center;
    }

    .status-success { background: #ecfdf3; color: #166534; border: 1px solid #bbf7d0; }
    .status-error   { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
    .status-info    { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }

    /* Miniatura da foto */
    .foto-preview {
      margin-top: 10px;
      text-align: center;
    }
    .foto-preview img {
      max-width: 120px;
      max-height: 120px;
      border-radius: 12px;
      border: 1px solid #cbd5e1;
      object-fit: cover;
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Lan√ßar despesas</h2>
    <p class="subtitle">Registre sua despesa com foto e dados obrigat√≥rios.</p>

    <label for="categoria">Categoria</label>
    <select id="categoria">
      <option value="">Selecione...</option>
      <option value="ALIMENTACAO">ALIMENTA√á√ÉO</option>
      <option value="TRANSPORTE">TRANSPORTE</option>
      <option value="HOSPEDAGEM">HOSPEDAGEM</option>
      <option value="OUTROS">OUTROS</option>
    </select>

    <div id="outros-container" style="display:none;">
      <label for="outros-tipo">Que tipo?</label>
      <input type="text" id="outros-tipo" placeholder="Ex.: Combust√≠vel, ped√°gio..." />
    </div>

    <label for="data-nota">Data da Nota</label>
    <input type="date" id="data-nota" />

    <label for="valor">Valor (R$)</label>
    <!-- teclado decimal, s√≥ v√≠rgula (bloqueamos . e ;) -->
    <input
      type="text"
      id="valor"
      inputmode="decimal"
      pattern="[0-9,]*"
      placeholder="Ex: 123,45"
    />

    <label for="comentario">Coment√°rio</label>
    <textarea id="comentario" rows="3" placeholder="Descreva a despesa..."></textarea>

    <div class="icon-area">
      <input type="file" id="upload-camera" accept="image/*" capture="environment" style="display:none;" />
      <label for="upload-camera" class="icon-btn">
        <span>üì∑</span>
        Tirar Foto
      </label>
    </div>

    <!-- Miniatura da foto tirada -->
    <div class="foto-preview">
      <img id="preview-foto" alt="Pr√©-visualiza√ß√£o da nota" />
    </div>

    <button class="btn-enviar" id="btn-enviar">Enviar despesa</button>

    <div id="status-box" class="status-box"><span id="status-text"></span></div>
  </div>

<script>
  const categoriaSelect = document.getElementById('categoria');
  const outrosContainer = document.getElementById('outros-container');
  const outrosInput = document.getElementById('outros-tipo');
  const comentarioInput = document.getElementById('comentario');
  const valorInput = document.getElementById('valor');
  const dataNotaInput = document.getElementById('data-nota');
  const cameraInput = document.getElementById('upload-camera');
  const btnEnviar = document.getElementById('btn-enviar');
  const statusBox = document.getElementById('status-box');
  const statusText = document.getElementById('status-text');
  const previewFoto = document.getElementById('preview-foto');

  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwPOFATnK2dvqnebVgyXe1WCXrQSx6GbFLBWlSvY3RqQBHplLY6BVuN3QhVddtMPtsuoQ/exec";

  let ultimoLinkFoto = "";

  function showMessage(msg, type) {
    statusBox.style.display = 'block';
    statusText.textContent = msg;
    statusBox.className = "status-box status-" + type;

    setTimeout(() => {
      statusBox.style.display = "none";
    }, 4000);
  }

  categoriaSelect.onchange = () => {
    const isOutros = categoriaSelect.value === "OUTROS";
    outrosContainer.style.display = isOutros ? "block" : "none";
    if (!isOutros) outrosInput.value = "";
  };

  // Bloquear ponto e ponto-e-v√≠rgula, e for√ßar v√≠rgula
  valorInput.addEventListener('keydown', (e) => {
    if (e.key === '.' || e.key === ';') {
      e.preventDefault(); // n√£o deixa digitar
    }
  });

  valorInput.addEventListener('input', () => {
    // se por algum motivo entrar ponto, converte para v√≠rgula
    if (valorInput.value.includes('.')) {
      valorInput.value = valorInput.value.replace(/\./g, ',');
    }
    // mant√©m somente n√∫meros e v√≠rgula
    valorInput.value = valorInput.value.replace(/[^0-9,]/g, '');
  });

  cameraInput.addEventListener("change", async () => {
    if (!cameraInput.files.length) return;

    const usuario = localStorage.getItem("pavi_notas_usuario") || "";

    const file = cameraInput.files[0];
    const formData = new FormData();
    formData.append("action", "uploadFoto");
    formData.append("usuario", usuario);
    formData.append("arquivo", file);

    showMessage("Enviando foto...", "info");

    try {
      const resp = await fetch(WEBAPP_URL, { method: "POST", body: formData });
      const data = await resp.json();

      if (data.status === "OK") {
        ultimoLinkFoto = data.link;
        showMessage("Foto anexada!", "success");

        // mostra miniatura
        if (ultimoLinkFoto) {
          previewFoto.src = ultimoLinkFoto;
          previewFoto.style.display = 'block';
        }
      } else {
        showMessage(data.mensagem || "Erro ao enviar a foto", "error");
      }
    } catch (err) {
      console.error(err);
      showMessage("Erro ao enviar a foto", "error");
    } finally {
      cameraInput.value = "";
    }
  });

  btnEnviar.onclick = async () => {
    if (!categoriaSelect.value) return showMessage("Escolha a categoria!", "error");
    if (!valorInput.value.trim()) return showMessage("Informe o valor!", "error");
    if (!dataNotaInput.value) return showMessage("Informe a data!", "error");
    if (!comentarioInput.value.trim()) return showMessage("Digite um coment√°rio!", "error");

    const usuario = localStorage.getItem("pavi_notas_usuario") || "";

    const payload = new URLSearchParams({
      action: "registro",
      usuario,
      categoria: categoriaSelect.value,
      tipo_outro: outrosInput.value.trim(),
      valor: valorInput.value.trim(),   // vai com v√≠rgula, como digitado
      obs: comentarioInput.value.trim(),
      data_nota: dataNotaInput.value,
      link: ultimoLinkFoto
    });

    btnEnviar.disabled = true;
    btnEnviar.textContent = "Enviando...";
    showMessage("Enviando...", "info");

    try {
      const resp = await fetch(WEBAPP_URL, { method: "POST", body: payload });
      const data = await resp.json();

      if (data.status === "OK") {
        showMessage("Registrado com sucesso!", "success");

        // limpa tudo
        categoriaSelect.value = "";
        outrosInput.value = "";
        outrosContainer.style.display = "none";
        valorInput.value = "";
        comentarioInput.value = "";
        dataNotaInput.value = "";
        ultimoLinkFoto = "";
        previewFoto.src = "";
        previewFoto.style.display = 'none';
      } else {
        showMessage(data.mensagem || "Erro ao registrar", "error");
      }
    } catch (err) {
      console.error(err);
      showMessage("Erro ao registrar", "error");
    } finally {
      btnEnviar.disabled = false;
      btnEnviar.textContent = "Enviar despesa";
    }
  };
</script>

</body>
</html>
